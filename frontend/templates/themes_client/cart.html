{% extends "themes_client/index.html" %}

{% block content %}
<style>
    .payment-img {
        width: 100px;
        height: auto;
        cursor: pointer;
    }
    .form-check {
        display: inline-block;
        margin-right: 20px;
    }
</style>
<script>
    function openConfirmationModal(mode_paiement) {
        var total_price = "{{ request.session.selected_total }}";
        var ordonnance_id = "{{ ordonnance_id }}";
        var confirmationMessage = "Vous avez choisi de payer avec " + mode_paiement + ". Le montant total à payer est de " + total_price + " FCFA.";
        document.getElementById('confirmationMessage').textContent = confirmationMessage;
        document.getElementById('mode_paiement').value = mode_paiement;
        $('#paymentModal').modal('hide');
        $('#confirmationModal').modal('show');
    }

    function dismissRefusedOrdonnance() {
        document.getElementById('refusedOrdonnance').style.display = 'none';
        document.getElementById('noOrderMessage').style.display = 'block';
    }

    $(document).ready(function() {
        {% if messages %}
            {% for message in messages %}
                alert("{{ message }}");
            {% endfor %}
        {% endif %}
    });
</script>

{% load static %}
<div class="container">
    <h2>Confirmation de Commande</h2>
    
    {% if commande_acceptee %}
    <div class="card">
        <div class="card-header">
            <h5>Ordonnance Acceptée</h5>
        </div>
        <div class="card-body">
            <h6>Liste des Médicaments Sélectionnés</h6>
            <ul class="list-group">
                {% for med in selected_medicines %}
                <li class="list-group-item">
                    {{ med.nom }} - {{ med.prix }} FCFA - Quantité: {{ med.quantite }} - Total: {{ med.total }} FCFA
                </li>
                {% endfor %}
            </ul>
            <p><strong>Prix Total:</strong> {{ selected_total }} FCFA</p>
        </div>
        <div class="card-footer">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#paymentModal">Payer la commande</button>
        </div>
    </div>
    {% elif commande_refusee %}
    <div class="card" id="refusedOrdonnance">
        <div class="card-header">
            <h5>Ordonnance Refusée</h5>
        </div>
        <div class="card-body">
            <p><strong>Motif du Refus:</strong> {{ refus_motif }}</p>
            <div>
                <strong>Image de la Commande:</strong>
                <img src="{{ request.session.commande_image }}" alt="Image de la commande" style="max-width: 100%; height: auto;">
            </div>
            <button type="button" class="btn btn-secondary mt-3" onclick="dismissRefusedOrdonnance()">OK, j'ai compris</button>
        </div>
    </div>
    {% endif %}
    <div class="alert alert-warning" role="alert" id="noOrderMessage" style="display: {% if commande_refusee %}none{% else %}block{% endif %};">
        Aucune commande en cours.
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Choisir le Mode de Paiement</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="payment-options">
                    <div class="form-check">
                        <a href="#" onclick="openConfirmationModal('tmoney')">
                            <img src="{% static 'themes_client/images/tmoney.png' %}" alt="Tmoney" class="img-thumbnail payment-img">
                        </a>
                    </div>
                    <div class="form-check">
                        <a href="#" onclick="openConfirmationModal('flooz')">
                            <img src="{% static 'themes_client/images/flooz.png' %}" alt="Flooz" class="img-thumbnail payment-img">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation de Paiement</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
                <form id="confirmationForm" method="post" action="{% url 'payement_commande' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="password">Veuillez entrer votre mot de passe:</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <input type="hidden" name="mode_paiement" id="mode_paiement">
                    <input type="hidden" name="ordonnance_id" value="{{ ordonnance_id }}">  <!-- Champ caché pour l'ID de l'ordonnance -->
                    <button type="submit" class="btn btn-primary">Confirmer le Paiement</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
