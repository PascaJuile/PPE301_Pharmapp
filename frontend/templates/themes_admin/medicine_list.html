{% extends "themes_admin/add_category.html" %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap4.min.css">
<link rel="stylesheet" href="{% static 'themes_admin/css/medicine_list.css' %}">
<link rel="stylesheet" href="{% static 'themes_admin/css/show_details1.css' %}">
<link rel="stylesheet" href="{% static 'themes_admin/css/sweetalert2.min.css' %}">

<!-- SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">

<style>
    /* CSS personnalisés pour SweetAlert2 */
    .swal-popup {
        width: 500px; /* Largeur de la boîte de dialogue */
        max-width: 90%; /* Assurer que la largeur ne dépasse pas 90% de l'écran */
        transition: transform 0.3s ease, box-shadow 0.3s ease; /* Ajouter une transition douce */
    }
    .swal-popup:hover {
        transform: scale(1.05); /* Agrandir légèrement la boîte de dialogue */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); /* Ajouter une ombre portée */
    }
    .swal-title {
        font-size: 2.5rem; /* Agrandir le titre */
    }
    .swal-content {
        font-size: 1.2rem; /* Agrandir le contenu */
    }
    .swal-confirm-button,
    .swal-cancel-button {
        padding: 0.75rem 1.5rem; /* Agrandir les boutons */
        font-size: 1rem; /* Agrandir le texte des boutons */
    }
    .low-stock {
        background-color: red !important;
        color: white !important; /* Optional: to make the text more readable */
    }
    
</style>

<body>
    <!-- Start Body -->
    <div class="body-page" id="body-page">
        <div class="medicine-list">
            <div class="card">
                <div class="card-header d-flex justify-content-between bd-highlight mb-3">
                    <div class="p-2 bd-highlight">Liste de médicaments</div>
                    <div class="p-2 bd-highlight">
                        <a href="{% url 'medicine_grid' %}"><button type="button" class="btn btn-list"><i class="fa fa-th"></i> &nbsp;Vue Grille</button></a>
                        <a href="{% url 'creation_medicament' %}"><button type="button" class="btn btn-list"><i class="fa fa-plus-square-o"></i> &nbsp;Ajout de médicaments</button></a>
                    </div>
                </div>
                <div class="card-body">
                    <table id="table" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%;">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Nom du Médicament</th>
                                <th scope="col">Nom Générique</th>
                                <th scope="col">Catégorie</th>
                                <th scope="col">Prix Unitaire</th>
                                <th scope="col">Date D'expiration</th>
                                <th scope="col">Image</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for medicament in medicaments %}
                                <tr class="{% if medicament.stock <= 5 %}low-stock{% endif %}">
                                    <th scope="row">{{ medicament.id }}</th>
                                    <td>{{ medicament.nomMedicament }}</td>
                                    <td>{{ medicament.code }}</td>
                                    <td>{{ medicament.medicamentCategorie.nomCat }}</td>
                                    <td>{{ medicament.prixUnitaire }}</td>
                                    <td>{{ medicament.dateExpiration }}</td>
                                    <td>
                                        {% if medicament.image and medicament.image.url %}
                                            <img src="{{ medicament.image.url }}" class="medicine-img" alt="{{ medicament.nomMedicament }}">
                                        {% else %}
                                            Image non disponible
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="row">
                                            <a href="{% url 'vmodifier_medicament' medicament.id %}" title="Edit"><i class="fas fa-edit"></i></a>
                                            <button type="button" class="btn btn-link delete-btn" data-id="{{ medicament.id }}"><i class="fa fa-trash" aria-hidden="true"></i></button>
                                            <a href="{% url 'show_details' medicament.id %}" title="Display"><i class="fas fa-expand-arrows-alt"></i></a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>                       
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- End Body -->

    <!-- SweetAlert JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.all.min.js"></script>
    <script>
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const medicamentId = this.getAttribute('data-id');
                Swal.fire({
                    title: 'Êtes-vous sûr de vouloir supprimer ce médicament?',
                    text: "Vous ne pourrez pas revenir en arrière !",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Oui, supprimez-le !',
                    cancelButtonText: 'Annuler',
                    customClass: {
                        container: 'swal-container',
                        popup: 'swal-popup',
                        title: 'swal-title',
                        content: 'swal-content',
                        confirmButton: 'swal-confirm-button',
                        cancelButton: 'swal-cancel-button'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`{% url 'supprimer_medicament' 0 %}`.replace('/0/', `/${medicamentId}/`), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ id: medicamentId })
                        }).then(response => {
                            if (response.ok) {
                                Swal.fire(
                                    'Supprimé !',
                                    'Le médicament a été supprimé.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Erreur !',
                                    'Il y a eu un problème lors de la suppression.',
                                    'error'
                                );
                            }
                        }).catch(error => {
                            console.error('Fetch Error:', error);
                            Swal.fire(
                                'Erreur !',
                                'Il y a eu un problème avec la requête.',
                                'error'
                            );
                        });
                    }
                });
            });
        });
    </script>
</body>
{% endblock content %}
