{% extends "themes_admin/themes_pharmacien/medicine_list.html" %}
{% block content %}
{% load static %}

<body>
    <div class="container">
        <h1 class="mt-5">Médicaments Sélectionnés Non Validés</h1>
        {% for selection in non_validated_medicines %}
        <h2>Selection ID: {{ selection.id }}</h2>
        <table class="table table-bordered mt-3">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prix Unitaire</th>
                    <th>Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for medicament in selection.donnees %}
                <tr>
                    <td>{{ medicament.nom }}</td>
                    <td>{{ medicament.prix }}</td>
                    <td>{{ medicament.quantite }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button class="btn btn-primary" onclick="validerCommande('{{ selection.id }}')">Valider la commande</button>
        <div id="details-{{ selection.id }}" style="display: none; margin-top: 20px;">
            <p>Total: <span id="totalPrice-{{ selection.id }}">0.00</span></p>
            <div class="form-group">
                <label for="amountReceived-{{ selection.id }}">Montant Reçu:</label>
                <input type="number" class="form-control" id="amountReceived-{{ selection.id }}" placeholder="Entrez le montant reçu" oninput="calculateChange('{{ selection.id }}')">
            </div>
            <p>Reliquat: <span id="changeDue-{{ selection.id }}">0.00</span></p>
            <form method="post" action="{% url 'afficher_medicaments_selectionnes' %}">
                {% csrf_token %}
                <input type="hidden" name="selection_id" value="{{ selection.id }}">
                <input type="hidden" name="total_price" id="hiddenTotalPrice-{{ selection.id }}" value="">
                <button class="btn btn-success" type="submit">Down</button>
            </form>
        </div>
        {% endfor %}
    </div>

    <div id="printableReceipt" style="display:none;">
        <div class="receipt">
            <h2>Pharmacie XYZ</h2>
            <p>Adresse: Rue Exemple, Ville</p>
            <p>Date: {{ date }}</p>
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prix Unitaire</th>
                        <th>Quantité</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- This will be filled dynamically -->
                </tbody>
            </table>
            <p>Total: <span id="printTotalPrice">0.00</span></p>
            <p>Montant Reçu: <span id="printAmountReceived">0.00</span></p>
            <p>Reliquat: <span id="printChangeDue">0.00</span></p>
        </div>
    </div>

    <style>
        .receipt {
            width: 300px;
            padding: 20px;
            margin: auto;
            border: 1px solid #000;
            font-family: Arial, sans-serif;
        }
        .receipt h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .receipt p {
            margin: 5px 0;
        }
        .receipt table {
            width: 100%;
            border-collapse: collapse;
        }
        .receipt table, .receipt th, .receipt td {
            border: 1px solid black;
        }
        .receipt th, .receipt td {
            padding: 8px;
            text-align: left;
        }
    </style>

    <script>
        function validerCommande(selectionId) {
            var totalPrice = 0;
            var rows = document.querySelectorAll(`#details-${selectionId} tbody tr`);
            rows.forEach(function(row) {
                var price = parseFloat(row.cells[1].innerText);
                var quantity = parseInt(row.cells[2].innerText);
                totalPrice += price * quantity;
            });
            document.getElementById('totalPrice-' + selectionId).innerText = totalPrice.toFixed(2);
            document.getElementById('details-' + selectionId).style.display = 'block';
        }

        function calculateChange(selectionId) {
            var amountReceived = parseFloat(document.getElementById('amountReceived-' + selectionId).value);
            var totalPrice = parseFloat(document.getElementById('totalPrice-' + selectionId).innerText);
            var changeDue = amountReceived - totalPrice;

            document.getElementById('changeDue-' + selectionId).innerText = changeDue.toFixed(2);
        }

        function printReceipt(selectionId) {
            var amountReceived = parseFloat(document.getElementById('amountReceived-' + selectionId).value);
            var changeDue = parseFloat(document.getElementById('changeDue-' + selectionId).innerText);

            document.getElementById('printTotalPrice').innerText = totalPrice.toFixed(2);
            document.getElementById('printAmountReceived').innerText = amountReceived.toFixed(2);
            document.getElementById('printChangeDue').innerText = changeDue.toFixed(2);

            var printContents = document.getElementById('printableReceipt').innerHTML;
            var originalContents = document.body.innerHTML;

            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload(); // Reload to restore the original state
        }
    </script>
</body>
{% endblock %}
