{% extends "themes_admin/themes_caissier/homepage_car.html" %}
{% block content %}
{% load static %}

<style>
    /* Styles spécifiques pour la page de sélection des médicaments */
    .med-container {
        margin-top: 20px;
        max-width: 1000px;
        margin-left: auto;
        margin-right: auto;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .med-title {
        font-size: 2.5em;
        margin-bottom: 20px;
        text-align: center;
        color: #03BB00;
        font-weight: bold;
    }

    .section-title {
        font-size: 2em;
        margin-top: 25px;
        border-bottom: 2px solid #03BB00;
        padding-bottom: 8px;
        color: #0085B2;
        text-align: center;
    }

    .med-table {
        margin-top: 20px;
        border-collapse: collapse;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .med-table th, .med-table td {
        padding: 3px;
        text-align: center;
        border: 1px solid #dee2e6;
        font-size: 15px;
    }

    .med-table th {
        background-color: #03BB00;
        color: #fff;
        font-weight: bold;
        text-transform: uppercase;
    }

    .med-table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .med-table tbody tr:hover {
        background-color: #e9ecef;
        transition: background-color 0.3s ease;
    }

    .btn-main, .btn-validate, .btn-print {
        margin-top: 20px;
        font-size: 1em;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        text-align: center;
        text-decoration: none;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .btn-main {
        background-color: #17a2b8 !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-main:hover {
        background-color: #0056b3;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-validate {
        background-color: #28a745;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-validate:hover {
        background-color: #218838;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-print {
        background-color: #ffc107;
        color: #212529;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-print:hover {
        background-color: #e0a800;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .form-container {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-group {
        margin-bottom: 15px;
    }

    .receipt-box {
        padding: 20px;
        border: 1px solid #dee2e6;
        background-color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
    }

    .receipt-box h2 {
        font-size: 1.8em;
        margin-bottom: 10px;
        color: #03BB00;
    }

    .receipt-box p {
        font-size: 1.2em;
        margin: 6px 0;
    }

    .receipt-box table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }

    .receipt-box th, .receipt-box td {
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: left;
    }

    .receipt-box th {
        background-color: #03BB00;
        color: #fff;
    }

    .receipt-box tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    /* Modal Styles */
    .modal-dialog {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1.75rem);
    }
    .modal-content {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .modal-header {
        background-color: #03BB00;
        color: #fff;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
    }
    .modal-title {
        font-size: 1.5em;
        font-weight: bold;
    }
    .modal-footer {
        border-top: none;
        border-radius: 0 0 8px 8px;
    }
    .modal-body ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .modal-body li {
        border-bottom: 1px solid #dee2e6;
        padding: 15px 0;
        font-size: 1.2em;
    }
    .modal-body li:last-child {
        border-bottom: none;
    }
</style>

<div class="med-container">
    <h1 class="med-title">Commandes Non Validées</h1>

    <!-- Affichage des commandes virtuelles -->
    <h2 class="section-title">Commandes Virtuelles</h2>
    {% for order in virtual_orders_with_fees %}
        <h2 class="section-title">Commande N° {{ order.selection.id }}</h2>
        <table class="med-table" id="table-{{ order.selection.id }}" data-frais-livraison="{{ order.frais_livraison }}">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prix Unitaire</th>
                    <th>Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for medicament in order.selection.donnees %}
                <tr>
                    <td>{{ medicament.nom }}</td>
                    <td>{{ medicament.prix_unitaire }}</td>
                    <td>{{ medicament.quantite }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if order.livreur_assigne %}
            <button class="btn btn-main" disabled>Livreur Assigné</button>
        {% else %}
            <button class="btn btn-main" data-toggle="modal" data-target="#assignDeliveryModal-{{ order.selection.id }}">Assigner Livreur</button>
        {% endif %}    
        <button class="btn btn-main" onclick="toggleDetails('{{ order.selection.id }}')">Valider la commande</button>
        <div id="details-{{ order.selection.id }}" class="form-container" style="display: none;">
            <p>Total: <span id="totalPrice-{{ order.selection.id }}">0.00</span> FCFA</p>
            <div class="form-group">
                <label for="amountReceived-{{ order.selection.id }}">Montant Reçu:</label>
                <input type="number" class="form-control" id="amountReceived-{{ order.selection.id }}" placeholder="Entrez le montant reçu" oninput="calculateChange('{{ order.selection.id }}')">
            </div>
            <p>Reliquat: <span id="changeDue-{{ order.selection.id }}">0.00</span> FCFA</p>
            <form method="post" action="{% url 'afficher_medicaments_selectionnes' %}">
                {% csrf_token %}
                <input type="hidden" name="selection_id" value="{{ order.selection.id }}">
                <input type="hidden" name="total_price" id="hiddenTotalPrice-{{ order.selection.id }}" value="">
                <button class="btn btn-validate" type="submit">Confirmer</button>
            </form>
            <button class="btn btn-print" onclick="printReceipt('{{ order.selection.id }}')">Imprimer le Reçu</button>
        </div>
    {% endfor %}

    <!-- Affichage des commandes présentielles -->
    <h2 class="section-title">Commandes Présentielles</h2>
    {% for selection in presencial_orders %}
        <h2 class="section-title">Commande N° {{ selection.id }}</h2>
        <table class="med-table" id="table-{{ selection.id }}">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prix Unitaire</th>
                    <th>Quantité</th>
                </tr>
            </thead>
            <tbody>
                {% for medicament in selection.donnees %}
                <tr>
                    <td>{{ medicament.nom }}</td>
                    <td>{{ medicament.prix_unitaire }}</td>
                    <td>{{ medicament.quantite }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button class="btn btn-main" onclick="toggleDetails('{{ selection.id }}')">Valider la commande</button>
        <div id="details-{{ selection.id }}" class="form-container" style="display: none;">
            <p>Total: <span id="totalPrice-{{ selection.id }}">0.00</span> FCFA</p>
            <div class="form-group">
                <label for="amountReceived-{{ selection.id }}">Montant Reçu:</label>
                <input type="number" class="form-control" id="amountReceived-{{ selection.id }}" placeholder="Entrez le montant reçu" oninput="calculateChange('{{ selection.id }}')">
            </div>
            <p>Reliquat: <span id="changeDue-{{ selection.id }}">0.00</span> FCFA</p>
            <form method="post" action="{% url 'afficher_medicaments_selectionnes' %}">
                {% csrf_token %}
                <input type="hidden" name="selection_id" value="{{ selection.id }}">
                <input type="hidden" name="total_price" id="hiddenTotalPrice-{{ selection.id }}" value="">
                <button class="btn btn-validate" type="submit">Confirmer</button>
            </form>
            <button class="btn btn-print" onclick="printReceipt('{{ selection.id }}')">Imprimer le Reçu</button>
        </div>
    {% endfor %}
</div>


<!-- Modal d'Assignation de Livreur -->
{% for order in virtual_orders_with_fees %}
<div class="modal fade" id="assignDeliveryModal-{{ order.selection.id }}" tabindex="-1" role="dialog" aria-labelledby="assignDeliveryModalLabel-{{ order.selection.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignDeliveryModalLabel-{{ order.selection.id }}">Assigner Livreur</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'assigner_livreur' %}">
                    {% csrf_token %}
                    <input type="hidden" name="selection_id" value="{{ order.selection.id }}">
                    <div class="form-group">
                        <label for="livreur-{{ order.selection.id }}">Sélectionner un livreur</label>
                        <select class="form-control" id="livreur-{{ order.selection.id }}" name="livreur">
                            {% for livreur in livreurs %}
                            <option value="{{ livreur.id }}">{{ livreur.nomUtilisateur }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Assigner</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<div id="printableReceipt" style="display:none;">
    <div class="receipt" style="padding: 20px; border: 1px solid #dee2e6; background-color: #ffffff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-radius: 8px; text-align: center; max-width: 500px; margin: 0 auto;">
        <h2>Pharmacie PharmApp</h2>
        <p>Adresse: Rue Bodjona Agbalepedo lossossimé</p>
        <p>Date: {{ date }}</p>
        <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Nom</th>
                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Prix Unitaire</th>
                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Quantité</th>
                </tr>
            </thead>
            <tbody id="receiptItems">
                <!-- This will be filled dynamically -->
            </tbody>
        </table>
        <div style="margin-top: 20px;">
            <p style="display: inline-block; margin-right: 20px;">Total: <span id="printTotalPrice">0.00</span> FCFA</p>
            <p style="display: inline-block; margin-right: 20px;">Montant Reçu: <span id="printAmountReceived">0.00</span> FCFA</p>
            <p style="display: inline-block;">Reliquat: <span id="printChangeDue">0.00</span> FCFA</p>
        </div>
    </div>
</div>

<script>
    function toggleDetails(id) {
        const details = document.getElementById(`details-${id}`);
        const isVisible = details.style.display === 'block';
        details.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) {
            calculateTotal(id);
        }
    }

    function calculateTotal(id) {
        const table = document.getElementById(`table-${id}`);
        let total = 0;
    
        // Calculer le total des médicaments
        table.querySelectorAll('tbody tr').forEach(row => {
            const price = parseFloat(row.cells[1].textContent);
            const quantity = parseInt(row.cells[2].textContent, 10);
            total += price * quantity;
        });
    
        // Ajouter les frais de livraison si c'est une commande virtuelle
        const fraisLivraison = parseFloat(table.getAttribute('data-frais-livraison')) || 0;
        total += fraisLivraison;
    
        // Mettre à jour l'affichage du total
        document.getElementById(`totalPrice-${id}`).textContent = total.toFixed(2);
        document.getElementById(`hiddenTotalPrice-${id}`).value = total.toFixed(2);
        document.getElementById(`changeDue-${id}`).textContent = '0.00';
    }
    
    function calculateChange(id) {
        const amountReceived = parseFloat(document.getElementById(`amountReceived-${id}`).value) || 0;
        const totalPrice = parseFloat(document.getElementById(`totalPrice-${id}`).textContent);
        const changeDue = amountReceived - totalPrice;
        document.getElementById(`changeDue-${id}`).textContent = changeDue.toFixed(2);
    }
    
    function printReceipt(id) {
        const receiptItems = document.getElementById('receiptItems');
        const table = document.getElementById(`table-${id}`);
        let receiptContent = '';
        table.querySelectorAll('tbody tr').forEach(row => {
            const name = row.cells[0].textContent;
            const price = row.cells[1].textContent;
            const quantity = row.cells[2].textContent;
            receiptContent += `<tr><td style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">${name}</td><td style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">${price}</td><td style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">${quantity}</td></tr>`;
        });
        receiptItems.innerHTML = receiptContent;
    
        const totalPrice = document.getElementById(`totalPrice-${id}`).textContent;
        const amountReceived = document.getElementById(`amountReceived-${id}`).value;
        const changeDue = document.getElementById(`changeDue-${id}`).textContent;
        document.getElementById('printTotalPrice').textContent = totalPrice;
        document.getElementById('printAmountReceived').textContent = amountReceived;
        document.getElementById('printChangeDue').textContent = changeDue;
    
        const receipt = document.getElementById('printableReceipt').innerHTML;
        const originalContents = document.body.innerHTML;
        document.body.innerHTML = receipt;
        window.print();
        document.body.innerHTML = originalContents;
    }
            
</script>


{% endblock %}
