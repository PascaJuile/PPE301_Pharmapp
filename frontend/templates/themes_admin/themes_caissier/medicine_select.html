{% extends "themes_admin/themes_pharmacien/medicine_list.html" %}
{% block content %}
{% load static %}

{% block sidebar %}
        <!-- Start Sidebar -->

        <div class="wrapper">

            <nav id="sidebar" class="sidebar">
    
                <div class="sidebar-logo" id="sidebar-logo">
                    <a href="#">
                        <div class="row">
                            <i class="fas fa-laptop-medical"></i>
                            <h3>PharmApp</h3>
                        </div>
                    </a>
                </div>
    
    
                <div class="user-info">
                    <div class="row">
                        <div class="user-img">
                            <img src="{% static 'themes_admin/img/user3.jpg' %}">
                        </div>
                        <div>
                            <p class="user-name">{{ request.session.user_name }}</p>
                            <p class="user-email">{{ request.session.user_email }}</p>
                        </div>
                    </div>
                </div>
    
                <div class="accordion" id="accordionExample">
    
                    <div class="card">
                        <div class="card-header">
                            <h2>
                                <button class="btn btn-link btn-block text-left" type="button">
                                    <a href="{% url 'homepage_phar' %}" class="icon-home"><i class="fa fa-fw fa-home"></i><span
                                            style="margin-left: 2px;">Acceuil</span></a>
                                </button>
                            </h2>
                        </div>
                    </div>
                    
    
                    <div class="card">
                        <div class="card-header" id="headingThree">
                            <h2>
                                <button class="btn btn-link btn-block text-left collapsed" type="button"
                                    data-toggle="collapse" data-target="#collapseThree" aria-expanded="false"
                                    aria-controls="collapseThree">
                                    <a class="option-name"><i class="fas fa-capsules"></i><span
                                            style="margin-left:4px;">Medicaments</span></a>
                                </button>
                            </h2>
                        </div>
                        <div id="collapseThree" class="collapse" aria-labelledby="headingThree"
                            data-parent="#accordionExample">
                            <div class="card-body">
                                <ul>
                                    <li><a href="{% url 'pharamacien_listeMedicament' %}">Ventes de Médicaments</a></li>
                                    <li><a href="{% url 'pharmacien_affichage_med' %}">Liste des médicaments</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
    
                      
                    <div class="card">
                        <div class="card-header" id="headingSixteen">
                            <h2>
                                <button class="btn btn-link btn-block text-left collapsed" type="button"
                                    data-toggle="collapse" data-target="#collapseFSixteen" aria-expanded="false"
                                    aria-controls="collapseFSixteen">
                                    <a class="option-name"><i class="fa fa-cog" aria-hidden="true"
                                            style="margin-left: 3px;"></i><span style="margin-left: 2px;">Paramètres</span></a>
                                </button>
                            </h2>
                        </div>
                        <div id="collapseFSixteen" class="collapse" aria-labelledby="headingSixteen"
                            data-parent="#accordionExample">
                            <div class="card-body">
                                <ul>
                                    <li><a href="#">Langage</a></li>
                                    <li><a href="{% url 'themes' %}">Thèmes</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    
        <!-- End Sidebar -->
    
{% endblock sidebar %}

<style>
    /* le style de la page sans contenu */
</style>

<div class="container">
    <h1 class="mt-5">Aucune commande n'a été ajoutée</h1>
    {% for selection in non_validated_medicines %}
    <h2>Selection ID: {{ selection.id }}</h2>
    <table class="table table-bordered mt-3" id="table-{{ selection.id }}">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Prix Unitaire</th>
                <th>Quantité</th>
            </tr>
        </thead>
        <tbody>
            {% for medicament in selection.donnees %}
            <tr>
                <td>{{ medicament.nom }}</td>
                <td>{{ medicament.prix }}</td>
                <td>{{ medicament.quantite }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button class="btn btn-primary" onclick="validerCommande('{{ selection.id }}')">Valider la commande</button>
    <div id="details-{{ selection.id }}" style="display: none; margin-top: 20px;">
        <p>Total: <span id="totalPrice-{{ selection.id }}">0.00</span></p>
        <div class="form-group">
            <label for="amountReceived-{{ selection.id }}">Montant Reçu:</label>
            <input type="number" class="form-control" id="amountReceived-{{ selection.id }}" placeholder="Entrez le montant reçu" oninput="calculateChange('{{ selection.id }}')">
        </div>
        <p>Reliquat: <span id="changeDue-{{ selection.id }}">0.00</span></p>
        <form method="post" action="{% url 'afficher_medicaments_selectionnes' %}">
            {% csrf_token %}
            <input type="hidden" name="selection_id" value="{{ selection.id }}">
            <input type="hidden" name="total_price" id="hiddenTotalPrice-{{ selection.id }}" value="">
            <button class="btn btn-success" type="submit">Confirmer</button>
        </form>
        <button class="btn btn-info" onclick="printReceipt('{{ selection.id }}')">Imprimer le Reçu</button>
    </div>
    {% endfor %}
</div>

<div id="printableReceipt" style="display:none;">
    <div class="receipt">
        <h2>Pharmacie XYZ</h2>
        <p>Adresse: Rue Exemple, Ville</p>
        <p>Date: {{ date }}</p>
        <table>
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prix Unitaire</th>
                    <th>Quantité</th>
                </tr>
            </thead>
            <tbody id="receiptItems">
                <!-- This will be filled dynamically -->
            </tbody>
        </table>
        <p>Total: <span id="printTotalPrice">0.00</span></p>
        <p>Montant Reçu: <span id="printAmountReceived">0.00</span></p>
        <p>Reliquat: <span id="printChangeDue">0.00</span></p>
    </div>
</div>

<script>
    function validerCommande(selectionId) {
        var totalPrice = 0;
        var rows = document.querySelectorAll(`#table-${selectionId} tbody tr`);
        rows.forEach(function(row) {
            var price = parseFloat(row.cells[1].innerText);
            var quantity = parseInt(row.cells[2].innerText);
            totalPrice += price * quantity;
        });
        document.getElementById('totalPrice-' + selectionId).innerText = totalPrice.toFixed(2);
        document.getElementById('hiddenTotalPrice-' + selectionId).value = totalPrice.toFixed(2);
        document.getElementById('details-' + selectionId).style.display = 'block';
    }

    function calculateChange(selectionId) {
        var amountReceived = parseFloat(document.getElementById('amountReceived-' + selectionId).value);
        var totalPrice = parseFloat(document.getElementById('totalPrice-' + selectionId).innerText);
        var changeDue = amountReceived - totalPrice;
        document.getElementById('changeDue-' + selectionId).innerText = changeDue.toFixed(2);
    }

    function printReceipt(selectionId) {
        var rows = document.querySelectorAll(`#table-${selectionId} tbody tr`);
        var receiptItems = document.getElementById('receiptItems');
        receiptItems.innerHTML = ''; 

        rows.forEach(function(row) {
            var name = row.cells[0].innerText;
            var price = row.cells[1].innerText;
            var quantity = row.cells[2].innerText;

            var newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${name}</td>
                <td>${price}</td>
                <td>${quantity}</td>
            `;
            receiptItems.appendChild(newRow);
        });

        var totalPrice = document.getElementById('totalPrice-' + selectionId).innerText;
        var amountReceived = document.getElementById('amountReceived-' + selectionId).value;
        var changeDue = document.getElementById('changeDue-' + selectionId).innerText;

        document.getElementById('printTotalPrice').innerText = totalPrice;
        document.getElementById('printAmountReceived').innerText = parseFloat(amountReceived).toFixed(2);
        document.getElementById('printChangeDue').innerText = changeDue;

        var printContents = document.getElementById('printableReceipt').innerHTML;
        var originalContents = document.body.innerHTML;

        document.body.innerHTML = printContents;
        window.print();
        document.body.innerHTML = originalContents;
        window.location.reload();
    }
</script>
{% endblock %}
